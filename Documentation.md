## Оглавление
1. [Общее описание](#общее-описание)
2. [Функциональные возможности](#функциональные-возможности)
3. [Архитектура проекта](#архитектура-проекта)
4. [Установка и настройка](#установка-и-настройка)
5. [Запуск проекта](#запуск-проекта)
6. [Описание модулей](#описание-модулей)
7. [Работа с базой данных](#работа-с-базой-данных)
8. [Взаимодействие с VK API](#взаимодействие-с-vk-api)
9. [Состояния бота](#состояния-бота)
10. [Обработка ошибок](#обработка-ошибок)
11. [Технические ограничения](#технические-ограничения)

## Общее описание

VK Dating Bot - это бот для социальной сети ВКонтакте, который помогает пользователям находить потенциальных партнеров по заданным параметрам. Бот анализирует профиль пользователя, предлагает подходящих кандидатов и позволяет сохранять понравившихся в избранное.

## Функциональные возможности

1. **Поиск кандидатов** по параметрам:
   - Возрастной диапазон
   - Пол
   - Город
   - Семейное положение

2. **Просмотр профилей**:
   - Топ-3 самых популярных фотографий (по количеству лайков)
   - Основная информация о кандидате
   - Ссылка на профиль

3. **Управление избранным**:
   - Добавление кандидатов в избранное
   - Просмотр списка избранных кандидатов

4. **Настройки поиска**:
   - Изменение города поиска
   - Настройка возрастного диапазона
   - Выбор пола для поиска

5. **Работа с приватными профилями**:
   - Возможность ручного ввода данных
   - Настройка параметров для приватных профилей

## Архитектура проекта

```
vk_dating_bot/
├── main.py                 # Точка входа
├── vk_dating_bot/          # Основные модули бота
│   ├── __init__.py
│   ├── bot.py              # Основная логика бота
│   ├── keyboards.py        # Генерация клавиатур
│   ├── vk_tools.py         # Работа с VK API
├── database/               # Работа с базой данных
│   ├── databasework.py     # Инициализация БД
│   ├── models.py           # Модели таблиц
│   ├── crud.py             # Операции с БД
│   ├── drop_tables.py      # Утилита удаления таблиц
├── config.py               # Конфигурационные параметры
└── requirements.txt        # Зависимости
```

## Установка и настройка

### Требования
- Python 3.7+
- PostgreSQL 10+
- Аккаунт ВКонтакте с правами администратора группы

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка конфигурации
Создайте файл `config.py` со следующим содержимым:
```python
# Токены VK API
GROUP_TOKEN = "ваш_токен_группы"
USER_TOKEN = "ваш_пользовательский_токен"
GROUP_ID = "id_вашей_группы"
API_VERSION = "5.131"  # Версия VK API

# Параметры подключения к БД
DSN = "postgresql://user:password@localhost:5432/dbname"

# Параметры по умолчанию
DEFAULT_AGE = 25
DEFAULT_CITY = 1  # ID Москвы
DEFAULT_CITY_TITLE = "Москва"
```

## Запуск проекта

1. Инициализация базы данных:
```bash
python main.py
```

2. Запуск бота:
```bash
python main.py
```

## Описание модулей

### 1. main.py
Точка входа в приложение. Выполняет:
- Проверку подключения к БД
- Создание таблиц
- Запуск основного цикла бота

### 2. bot.py
Основной модуль бота, содержащий класс `DatingBot`. Реализует:
- Обработку входящих сообщений
- Управление состояниями пользователей
- Логику поиска кандидатов
- Работу с избранным
- Взаимодействие с пользователем через клавиатуры

### 3. keyboards.py
Генератор клавиатур для бота. Содержит функции:
- `get_main_keyboard()` - основная клавиатура
- `get_settings_keyboard()` - клавиатура настроек
- `get_search_keyboard()` - клавиатура поиска
- `get_empty_keyboard()` - пустая клавиатура

### 4. vk_tools.py
Модуль для работы с VK API. Основные функции:
- `get_user_info()` - получение информации о пользователе
- `search_users()` - поиск кандидатов
- `get_top_photos()` - получение популярных фотографий
- `find_city()` - поиск города по названию

### 5. Модули базы данных

#### models.py
Определяет структуру базы данных:
- `Users` - пользователи бота
- `Candidates` - кандидаты
- `Photos` - фотографии кандидатов
- `Interactions` - взаимодействия пользователей с кандидатами
- `UsersCandidates` - связи между пользователями и кандидатами

#### crud.py
Операции с базой данных:
- `add_user()` - добавление пользователя
- `add_candidate_with_link()` - добавление кандидата
- `add_interaction()` - добавление взаимодействия
- `get_favorite_candidates()` - получение избранных кандидатов

#### databasework.py
Инициализация подключения к БД и создание таблиц.

#### drop_tables.py
Утилита для удаления таблиц (для разработки).

## Работа с базой данных

### Структура БД
1. **users** - пользователи бота
   - vk_id, name, age, gender, city_id, city_title

2. **candidates** - кандидаты
   - vk_id, name, age, gender, city_id, city_title

3. **photos** - фотографии кандидатов
   - candidate_id, first_photo, second_photo, third_photo, account_link

4. **interactions** - взаимодействия
   - user_id, candidate_id, status (like, favorite и т.д.)

5. **users_candidates** - связи пользователей и кандидатов

### Миграции
Для изменения структуры БД:
1. Удалите таблицы (при необходимости):
```bash
python database/drop_tables.py
```
2. Перезапустите бота для создания новых таблиц.

## Взаимодействие с VK API

Бот использует два типа токенов:
1. `GROUP_TOKEN` - для работы бота в группе
2. `USER_TOKEN` - для выполнения запросов к API от имени пользователя

Основные методы API:
- `users.get` - получение информации о пользователях
- `users.search` - поиск пользователей
- `photos.get` - получение фотографий
- `database.getCities` - поиск городов

## Состояния бота

Бот использует систему состояний для обработки многошаговых сценариев:
1. `waiting_city` - ожидание ввода города
2. `waiting_city_select` - ожидание выбора города из списка
3. `waiting_age_from` - ожидание ввода минимального возраста
4. `waiting_age_to` - ожидание ввода максимального возраста
5. `waiting_manual_city` - ожидание ручного ввода города
6. `waiting_manual_age` - ожидание ручного ввода возраста

## Обработка ошибок

Бот включает несколько уровней обработки ошибок:
1. Ошибки VK API (ограничение запросов, недоступность методов)
2. Ошибки базы данных (потеря соединения, нарушение ограничений)
3. Ошибки ввода пользователя (некорректные данные)
4. Системные ошибки (исключения)

Для каждой критической операции предусмотрены:
- Попытки повтора
- Откат транзакций
- Логирование ошибок
- Гибкая обработка исключений

## Технические ограничения

1. **Ограничения VK API**:
   - Не более 3 запросов в секунду
   - Ограниченное количество запросов в день
   - Не все данные доступны для закрытых профилей

2. **Ограничения бота**:
   - Работа только в группах ВКонтакте
   - Требуются права доступа к API
   - Ограниченный набор параметров поиска

3. **Рекомендации**:
   - Использовать отдельный аккаунт для USER_TOKEN
   - Регулярно обновлять токены
   - Мониторить ограничения API